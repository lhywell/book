# Application

@(笔记)[node模块]

-------------------
> App对象表示express应用程序，var app = express()


### App的属性

属性包括app.locals，app.mountpath等...

#### app.locals

app.locals属性的值将在应用程序的整个生命周期中保持不变，默认保存着app.settings的内容，同时也可以增加新的属性，通过app.locals.xxx = xxx

源码：
```js
// default locals
this.locals.settings = this.settings;
```

![express](https://github.com/lhywell/book/blob/master/express4.x/express001.png)

如何做到在整个生命周期保持不变呢?

![express](https://github.com/lhywell/book/blob/master/express4.x/express2001.png)


是因为，在每次调用app.render方法的时候，做了3件事情

1. 把app.locals与一个空对象合并
2. 把app.render的options.locals与空对象合并
3. 把app.render的options与空对象合并

merge方法是调用的一个第三方包require('utils-merge')，主要作用就是合并两个对象
```js
var a = { foo: 'bar' }
  , b = { bar: 'baz' };
 
merge(a, b);
// => { foo: 'bar', bar: 'baz' }
```

#### app.mountpath
初始默认是'/'，跟req.baseUrl很相似，区别就在于，由正则表达式组成的路由，会有不同，当请求[http://localhost:3000/admddin]的时候

```js
var admin = express(); // the sub app

admin.get('/', function (req, res) {
  console.log(111,req.baseUrl); // 111 '/admddin'
  console.log(222,admin.mountpath); // 222 '/adm*in'
  res.send('Admin Homepage');
})

app.use('/adm*in', admin); // mount the sub app
```

#### app.settings
初始化通过调用app.set()方法，生成了包括渲染引擎模板，渲染引擎的路径，etag设置，jsonp命名等...

![express](https://github.com/lhywell/book/blob/master/express4.x/express2002.png)

#### app.engines
注意这里有s

#### app.cache
#### app.domain
#### app._router

路由存放在stack中

![express](https://github.com/lhywell/book/blob/master/express4.x/express002.png)

### App的方法
用途：
- HTTP路由请求 app.METHOD and app.param.
- 配置中间件 app.route
- 呈现HTML视图 app.render
- 注册模板引擎 app.engine

#### app.METHOD(path, callback [, callback ...])
路由相关的http请求方法，app.all(),app.get(), app.post(), app.put(), and app.delete()


#### app.param
在任何路由中间件处理函数之前调用，即使位置放在他们的后边，并且只调用一次，
例如：请求(http://localhost:3000/user/4)
```js
app.get('/user/:id', function (req, res, next) {
  console.log('although this matches');
  next();
});

app.get('/user/:id', function (req, res) {
  console.log('and this matches too');
  res.end();
});
app.param('id', function (req, res, next, value) {
  console.log('CALLED ONLY ONCE with', value);
  next();
})

//CALLED ONLY ONCE with 4
//although this matches
//and this matches too
```
#### app.render(view, [locals], callback)

#### app.route(path)
可以为路由路径创建链式路由句柄

#### app.set(name, value)
#### app.get(name)

app setting table
```js
console.log('case sensitive routing:',app.get('case sensitive routing'))
console.log('env:',app.get('env'))
console.log('etag:',app.get('etag'))
console.log('jsonp callback name:',app.get('jsonp callback name'))
console.log('json replacer:',app.get('json replacer'))
console.log('json spaces:',app.get('json spaces'))
console.log('query parser:',app.get('query parser'))
console.log('strict routing:',app.get('strict routing'))
console.log('subdomain offset:',app.get('subdomain offset'))
console.log('trust proxy:',app.get('trust proxy'))
console.log('views:',app.get('views'))
console.log('view cache:',app.get('view cache'))
console.log('view engine:',app.get('view engine'))
console.log('x-powered-by:',app.get('x-powered-by'))

//case sensitive routing: undefined
//env: development
//etag: weak
//jsonp callback name: callback
//json replacer: undefined
//json spaces: undefined
//query parser: extended
//strict routing: undefined
//subdomain offset: 2
//trust proxy: false
//views: E:\ixuexi\http\views
//view cache: undefined
//view engine: undefined
//x-powered-by: true

```

#### app.use([path,] function [, function...])
安装中间件，默认路径'/'，可以定义静态资源，可以定义路由，可以定义子进程

中间件的顺序很重要，例子：下一个get方法没有执行到

```js
// this middleware will not allow the request to go beyond it
app.use(function(req, res, next) {
  res.send('Hello World');
})

// requests will never reach this route
app.get('/', function (req, res) {
  res.send('Welcome');
})
```




上一页：[express基本概念](https://github.com/lhywell/book/tree/master/express4.x/README.md)

下一页：[Request对象](https://github.com/lhywell/book/blob/master/express4.x/1.2README.md)