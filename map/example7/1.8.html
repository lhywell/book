<!doctype html>
<html>

<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta name="keywords" content="我秀地图" />
    <title>我秀地图－地图API－范例－画九宫格+监听事件</title>
    <script src="http://api.ishowchina.com/v4/webapi/js/auth?v=3.6.3&t=jsmap&ak=ec85d3648154874552835438ac6a02b2"></script>
    <script type="text/javascript">
    var map, lnglats = [];

    //center = new LD.LngLat(116.31101, 39.921623); //9宫格中心点
    var addEvent;
    //地图初始化
    function init() {
        var mapOpt = new LD.MapOptions();
        mapOpt.zoom = 14;
        mapOpt.minZoom = 4;
        mapOpt.maxZoom = 18;
        mapOpt.keyboard = false;
        mapOpt.isTileLayer = true;
        mapOpt.center = new LD.LngLat(116.31101, 39.921623);
        map = new LD.Map("map", mapOpt);
        // console.log(map.mapObj)

        map.addEventListener(IMAP.Constants.CLICK, (evtObj) => {
            var lng = evtObj.lnglat.lng;
            var lat = evtObj.lnglat.lat;

            var lnglat = evtObj.lnglat;
            let marker = drawMarker(lnglat);
            map.getOverlayLayer().addOverlay(marker);

            this.draw9(76, lnglat, lng, lat);
        }, map);


        map.addControl(new LD.NavigationControl()); //添加导航条
        map.addControl(new LD.ScaleControl()); //添加比例尺
    }

    function removeEvent(addEvent) {
        if (map) {
            map.removeEventListener(addEvent);
        }
    }

    function draw9(m, lnglat, lng, lat) {
        console.log(lng)
        var r = getR(m, lng, lat) * 2 /*9宫格半径（单位米）*/ ,
            pixels = [],
            pixes = [];
        //左边中间点
        var c = map.lnglatToLayerPixel(lnglat);
        console.log(c)
        var l = new LD.Pixel(c.x - (r / 2 + r), c.y);
        //左边2点
        var l2 = new LD.Pixel(l.x, l.y - r / 2);
        //左边1点
        var l1 = new LD.Pixel(l2.x, l2.y - r);
        //左边3点
        var l3 = new LD.Pixel(l2.x, l2.y + r);
        //左边3点
        var l4 = new LD.Pixel(l3.x, l3.y + r);

        //中间左1
        var lc1 = new LD.Pixel(l1.x + r, l1.y);
        //中间左1
        var lc2 = new LD.Pixel(l2.x + r, l2.y);
        //中间左3
        var lc3 = new LD.Pixel(l3.x + r, l3.y);
        //中间左4
        var lc4 = new LD.Pixel(l4.x + r, l4.y);

        //中间右1
        var rc1 = new LD.Pixel(lc1.x + r, lc1.y);
        //中间左2
        var rc2 = new LD.Pixel(lc2.x + r, lc2.y);
        //中间右3
        var rc3 = new LD.Pixel(lc3.x + r, lc3.y);
        //中间右4
        var rc4 = new LD.Pixel(lc4.x + r, lc4.y);

        //右1
        var r1 = new LD.Pixel(rc1.x + r, rc1.y);
        //右2
        var r2 = new LD.Pixel(rc2.x + r, rc2.y);
        //右3
        var r3 = new LD.Pixel(rc3.x + r, rc3.y);
        //右4
        var r4 = new LD.Pixel(rc4.x + r, rc4.y);

        //所有点包括中心四点
        pixes.push(l1);
        pixes.push(l2);
        pixes.push(l3);
        pixes.push(l4);

        pixes.push(lc4);
        pixes.push(rc4);
        pixes.push(r4);
        //右边线3个点
        pixes.push(r3);
        pixes.push(r2);
        pixes.push(r1);
        //底部线3个点
        pixes.push(rc1);
        pixes.push(lc1);

        pixes.push(lc2);
        pixes.push(lc3);
        pixes.push(rc2);
        pixes.push(rc3);

        //addMarker(center);
        var lnglats2 = [];
        for (var i = 0, l = pixes.length; i < l; ++i) {
            var lnglats1 = map.layerPixelToLnglat(pixes[i]);
            lnglats2.push(lnglats1);
        }
        console.log(lnglats2)
        getBoundsArray(lnglats2)
    }

    function getR(num, lng, lat) {
        // console.log(map)
        var mapObj = map.mapObj;
        // console.log(mapObj)
        var lng = lng,
            lat = lat,
            crs = mapObj.options.crs;
        if (crs.distance === L.CRS.Earth.distance) {
            var d = Math.PI / 180,
                latR = (num / L.CRS.Earth.R) / d,
                top = mapObj.project([lat + latR, lng]),
                bottom = mapObj.project([lat - latR, lng]),
                p = top.add(bottom).divideBy(2),
                lat2 = mapObj.unproject(p).lat,
                lngR = Math.acos((Math.cos(latR * d) - Math.sin(lat * d) * Math.sin(lat2 * d)) /
                    (Math.cos(lat * d) * Math.cos(lat2 * d))) / d;

            if (isNaN(lngR) || lngR === 0) {
                lngR = latR / Math.cos(Math.PI / 180 * lat); // Fallback for edge case, #2425
            }

            var _radius = isNaN(lngR) ? 0 : Math.max(Math.round(p.x - mapObj.project([lat2, lng - lngR]).x), 1);
            var _radiusY = Math.max(Math.round(p.y - top.y), 1);
        } else {
            var latlng2 = crs.unproject(crs.project([lat, lng]).subtract([num, 0]));
            var _point = mapObj.latLngToLayerPoint([lat, lng]);
            var _radius = this._point.x - map.latLngToLayerPoint(latlng2).x;
        }
        return _radiusY || _radius;
    }
    //获取9个格子的范围
    function getBoundsArray(lnglat) {
        var rect1 = drawRect(lnglat[1], lnglat[11], 0.5);
        var rect2 = drawRect(lnglat[12], lnglat[10], 0.1);
        var rect3 = drawRect(lnglat[14], lnglat[9], 0.5);

        var rect4 = drawRect(lnglat[2], lnglat[12], 0.1);
        var rect5 = drawRect(lnglat[13], lnglat[14], 0.5);
        var rect6 = drawRect(lnglat[15], lnglat[8], 0.1);

        var rect7 = drawRect(lnglat[3], lnglat[13], 0.5);
        var rect8 = drawRect(lnglat[4], lnglat[15], 0.1);
        var rect9 = drawRect(lnglat[5], lnglat[7], 0.5);

        console.log(rect1)
        rect1.addEventListener(IMAP.Constants.CLICK, () => {
            alert(1)
        }, rect1);

        rect2.addEventListener(IMAP.Constants.CLICK, () => {
            alert(2)
        }, rect1);

        rect3.addEventListener(IMAP.Constants.CLICK, () => {
            alert(3)
        }, rect1);

        rect4.addEventListener(IMAP.Constants.CLICK, () => {
            alert(4)
        }, rect1);

        rect5.addEventListener(IMAP.Constants.CLICK, () => {
            alert(5)
        }, rect1);

        rect6.addEventListener(IMAP.Constants.CLICK, () => {
            alert(6)
        }, rect1);

        rect7.addEventListener(IMAP.Constants.CLICK, () => {
            alert(7)
        }, rect1);

        rect8.addEventListener(IMAP.Constants.CLICK, () => {
            alert(8)
        }, rect1);

        rect9.addEventListener(IMAP.Constants.CLICK, () => {
            alert(9)
        }, rect1);

        map.getOverlayLayer().addOverlays([rect1, rect2, rect3, rect4, rect5, rect6, rect7, rect8, rect9], true);
    }

    function drawRect(swstr, nestr, opacity) {
        let opts = new IMAP.RectangleOptions();
        if (opacity == 0.5) {
            opts.fillOpacity = 0.5;
        } else {
            opts.fillOpacity = 0.1;
        }
        opts.fillColor = "#C6FACE";
        opts.strokeColor = "#0FD62C";
        opts.strokeOpacity = 1;
        opts.strokeWeight = 3;
        opts.strokeStyle = "solid";

        let rect = new IMAP.Rectangle(new IMAP.LngLatBounds(swstr, nestr), opts);

        return rect;
    }

    function drawMarker(lnglat, type, status) {
        let opts = new IMAP.MarkerOptions();
        opts.anchor = IMAP.Constants.BOTTOM_CENTER;
        var type, status;
        switch (type) {
            case 'circle':
                type = 'circle';
                break;
            case 'polygon':
                type = 'polygon';
                break;
            case 'driving':
                type = 'driving';
                break;
            case 'sudoku':
                type = 'sudoku';
                break;
            default:
                type = 'default';
                break;
        }
        switch (status) {
            case 'unsave':
                status = 'unsave';
                break;
            case 'save':
                status = 'save';
                break;
            case 'computing':
                status = 'computing';
                break;
            case 'computed':
                status = 'computed';
                break;
            default:
                status = 'blue';
                break;
        }

        // $static + "/" + type + '-' + status + '.png'
        opts.icon = new IMAP.Icon(IMAP.MapConfig.API_REALM_NAME + "images/point_1.png", {
            "size": new IMAP.Size(35, 30),
            "offset": new IMAP.Pixel(5, 0)
        });
        var marker = new IMAP.Marker(lnglat, opts);

        return marker;
    }
    </script>
</head>

<body onload="init()">
    <div id="map" style="width:80%; height:90%;position: absolute;"></div>
</body>

</html>