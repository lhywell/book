<!doctype html>
<html>

<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta name="keywords" content="我秀地图" />
    <title>我秀地图－地图API－范例－画九宫格-线</title>
    <script src="http://api.ishowchina.com/v4/webapi/js/auth?v=3.4.3&t=jsmap&ak=ec85d3648154874552835438ac6a02b2"></script>
    <script type="text/javascript">
    var map, lnglats = [],
        lnglats2 = [],
        center = new LD.LngLat(116.31101, 39.921623); //9宫格中心点
    //地图初始化
    function init() {
        var mapOpt = new LD.MapOptions();
        mapOpt.zoom = 14;
        mapOpt.minZoom = 4;
        mapOpt.maxZoom = 18;
        mapOpt.keyboard = false;
        mapOpt.isTileLayer = true;
        mapOpt.center = new LD.LngLat(116.31101, 39.921623);
        map = new LD.Map("map", mapOpt);
        map.addControl(new LD.NavigationControl()); //添加导航条
        map.addControl(new LD.ScaleControl()); //添加比例尺
        draw9(152);
    }

    function draw9(m) {
        var r = getR(m) * 2 /*9宫格半径（单位米）*/ ,
            pixels = [],
            pixes = [];
        //左边中间点
        var c = map.lnglatToLayerPixel(center);

        var l = new LD.Pixel(c.x - (r / 2 + r), c.y);
        //左边2点
        var l2 = new LD.Pixel(l.x, l.y - r / 2);
        //左边1点
        var l1 = new LD.Pixel(l2.x, l2.y - r);
        //左边3点
        var l3 = new LD.Pixel(l2.x, l2.y + r);
        //左边3点
        var l4 = new LD.Pixel(l3.x, l3.y + r);

        //中间左1
        var lc1 = new LD.Pixel(l1.x + r, l1.y);
        //中间左1
        var lc2 = new LD.Pixel(l2.x + r, l2.y);
        //中间左3
        var lc3 = new LD.Pixel(l3.x + r, l3.y);
        //中间左4
        var lc4 = new LD.Pixel(l4.x + r, l4.y);

        //中间右1
        var rc1 = new LD.Pixel(lc1.x + r, lc1.y);
        //中间左2
        var rc2 = new LD.Pixel(lc2.x + r, lc2.y);
        //中间右3
        var rc3 = new LD.Pixel(lc3.x + r, lc3.y);
        //中间右4
        var rc4 = new LD.Pixel(lc4.x + r, lc4.y);

        //右1
        var r1 = new LD.Pixel(rc1.x + r, rc1.y);
        //右2
        var r2 = new LD.Pixel(rc2.x + r, rc2.y);
        //右3
        var r3 = new LD.Pixel(rc3.x + r, rc3.y);
        //右4
        var r4 = new LD.Pixel(rc4.x + r, rc4.y);

        //左边线
        pixels.push(l1);
        pixels.push(l2);
        pixels.push(l3);
        pixels.push(l4);
        //底部线3个点
        pixels.push(lc4);
        pixels.push(rc4);
        pixels.push(r4);
        //右边线3个点
        pixels.push(r3);
        pixels.push(r2);
        pixels.push(r1);
        //底部线3个点
        pixels.push(rc1);
        pixels.push(lc1);
        pixels.push(l1);
        //中间左竖线
        pixels.push(lc1); //回到左竖线的起点
        pixels.push(lc4);
        //中间右竖线
        pixels.push(rc4); //移到右竖线底点
        pixels.push(rc1);
        pixels.push(r1); //移到右线顶点
        //中间第一条横线
        pixels.push(r2); //移到右线第二个点
        pixels.push(l2);
        //中间第二条横线
        pixels.push(l3); //移到左线第三个点
        pixels.push(r3);

        //所有点包括中心四点
        pixes.push(l1);
        pixes.push(l2);
        pixes.push(l3);
        pixes.push(l4);

        pixes.push(lc4);
        pixes.push(rc4);
        pixes.push(r4);
        //右边线3个点
        pixes.push(r3);
        pixes.push(r2);
        pixes.push(r1);
        //底部线3个点
        pixes.push(rc1);
        pixes.push(lc1);

        pixes.push(lc2);
        pixes.push(lc3);
        pixes.push(rc2);
        pixes.push(rc3);
        for (var i = 0, l = pixels.length; i < l; ++i) {
            var lnglat = map.layerPixelToLnglat(pixels[i]);
            lnglats.push(lnglat);
        }
        console.log(lnglats)
        addPolyline(lnglats);
        addMarker(center);

        for (var i = 0, l = pixes.length; i < l; ++i) {
            var lnglats1 = map.layerPixelToLnglat(pixes[i]);
            lnglats2.push(lnglats1);
        }
        console.log(lnglats2)
        console.log(getBoundsArray(lnglats2))
    }

    function getR(num) {
        var mapObj = map.mapObj;
        var lng = center.lng,
            lat = center.lat,
            crs = mapObj.options.crs;
        if (crs.distance === L.CRS.Earth.distance) {
            var d = Math.PI / 180,
                latR = (num / L.CRS.Earth.R) / d,
                top = mapObj.project([lat + latR, lng]),
                bottom = mapObj.project([lat - latR, lng]),
                p = top.add(bottom).divideBy(2),
                lat2 = mapObj.unproject(p).lat,
                lngR = Math.acos((Math.cos(latR * d) - Math.sin(lat * d) * Math.sin(lat2 * d)) /
                    (Math.cos(lat * d) * Math.cos(lat2 * d))) / d;

            if (isNaN(lngR) || lngR === 0) {
                lngR = latR / Math.cos(Math.PI / 180 * lat); // Fallback for edge case, #2425
            }

            var _radius = isNaN(lngR) ? 0 : Math.max(Math.round(p.x - mapObj.project([lat2, lng - lngR]).x), 1);
            var _radiusY = Math.max(Math.round(p.y - top.y), 1);
        } else {
            var latlng2 = crs.unproject(crs.project([center.lat, center.lng]).subtract([num, 0]));
            var _point = mapObj.latLngToLayerPoint([center.lat, center.lng]);
            var _radius = this._point.x - map.latLngToLayerPoint(latlng2).x;
        }
        return _radiusY || _radius;
    }
    //获取9个格子的范围
    function getBoundsArray(lnglat) {
        var b1 = new LD.LngLatBounds(lnglat[1], lnglat[11]);
        var b2 = new LD.LngLatBounds(lnglat[12], lnglat[10]);
        var b3 = new LD.LngLatBounds(lnglat[14], lnglat[9]);

        var b4 = new LD.LngLatBounds(lnglat[2], lnglat[12]);
        var b5 = new LD.LngLatBounds(lnglat[13], lnglat[14]);
        var b6 = new LD.LngLatBounds(lnglat[15], lnglat[8]);

        var b7 = new LD.LngLatBounds(lnglat[3], lnglat[13]);
        var b8 = new LD.LngLatBounds(lnglat[4], lnglat[15]);
        var b9 = new LD.LngLatBounds(lnglat[5], lnglat[7]);
        return [b1, b2, b3, b4, b5, b6, b7, b8, b9];
    }

    function addPolyline(path) {
        var line = new LD.Polyline(path);
        map.getOverlayLayer().addOverlay(line);
    }

    function addMarker(lnglat) {
        map.getOverlayLayer().addOverlay(new LD.Marker(lnglat, {
            icon: new IMAP.Icon(IMAP.MapConfig.API_REALM_NAME + "images/point_1.png", { "size": new IMAP.Size(35, 30), "offset": new IMAP.Pixel(1, 0) })
        }));
    }
    </script>
</head>

<body onload="init()">
    <div id="map" style="width:80%; height:90%;position: absolute;"></div>
    <div style="position:absolute;right:1px;width:19%;height:99%;font-size: 12px;line-height: 28px;overflow: auto;">
    </div>
</body>

</html>